"use strict";var e=require("cors"),t=require("dotenv"),r=require("express"),n=require("winston"),o=require("atob"),a=require("bcrypt"),u=require("http-errors"),s=require("jsonwebtoken"),i=require("morgan"),l=require("fs");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function f(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var p=c(e),d=c(t),v=c(r),h=f(n),m=c(o),b=c(a),g=c(u),y=c(s),w=c(i),O=c(l);h.addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});var S=h.format.combine(h.format.timestamp({format:"YYYY-MM-DD HH:mm:ss:ms"}),h.format.colorize({all:!0}),h.format.printf((function(e){return e.timestamp+" "+e.level+": "+e.message}))),E=[new h.transports.Console,new h.transports.File({filename:"../logs/error.log",level:"error"}),new h.transports.File({filename:"../logs/all.log"})],R=h.createLogger({level:"development"===(process.env.NODE_ENV||"development")?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},format:S,transports:E});function k(e,t,r,n){return new(r||(r=Promise))((function(o,a){function u(e){try{i(n.next(e))}catch(e){a(e)}}function s(e){try{i(n.throw(e))}catch(e){a(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,s)}i((n=n.apply(e,t||[])).next())}))}function j(e,t){var r,n,o,a,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return u.label++,{value:a[1],done:!1};case 5:u.label++,n=a[1],a=[0];continue;case 7:a=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){u=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){u.label=a[1];break}if(6===a[0]&&u.label<o[1]){u.label=o[1],o=a;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(a);break}o[2]&&u.ops.pop(),u.trys.pop();continue}a=t.call(e,u)}catch(e){a=[6,e],n=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}var q=function(e,t,r){return k(this,void 0,void 0,(function(){var n,o,a,u,s,i,l,c;return j(this,(function(f){switch(f.label){case 0:if(!(n=e.headers.authorization))return[2,r(g.default(401,"Unauthorized."))];o=n.split("Basic "),a=o[1];try{u=m.default(a)}catch(e){return[2,r(g.default(400,"Malformed auth token."))]}return s=u.split(":"),i=s[0],l=s[1],i!==process.env.USERNAME?[2,r(g.default(401,"Unauthorized."))]:[4,b.default.compare(l,process.env.PASSWORD)];case 1:return f.sent()?(c=y.default.sign({username:i,mapToken:process.env.MAP_TOKEN},process.env.SECRET_KEY,{expiresIn:"1h"}),t.type("application/json").status(200).send(JSON.stringify({token:c})),[2,r()]):[2,r(g.default(401,"Unauthorized."))]}}))}))},_=function(e,t,r){var n=e.headers.authorization;if(!n)return r(g.default(401,"Unauthorized"));var o=n.split("Bearer ")[1];try{y.default.verify(o,process.env.SECRET_KEY)}catch(e){return r(g.default(401,"Unauthorized"))}};var z={write:function(e){return R.http(e)}},N=w.default(":method :url :status :res[content-length] - :response-time ms",{stream:z,skip:function(){return"development"!==(process.env.NODE_ENV||"development")}}),P=v.default.Router();P.post("/",q);var x=function(e,t,r){return t.status(200).type("application/json"),new Promise((function(e){var n=O.default.createReadStream("data/boat_ramps.geojson").pipe(t);n.on("close",(function(){t.end(),e(r())})),n.on("error",(function(){e(r(g.default(500,"Server failed to read data.")))}))}))},T=v.default.Router();T.get("/boat-ramps",x);var C=v.default.Router();C.get("/",(function(e,t){t.status(200).send("ok")})),d.default.config();var D=v.default();R.info(">>>",process.env.CORS_ORIGIN),D.use(N),D.use(p.default({origin:process.env.CORS_ORIGIN,optionsSuccessStatus:200})),D.use("/health-check",C),D.use("/auth",P),D.use("/data",(function(e,t,r){_(e,t,r),r()}),T),D.use((function(e,t,r,n){return R.error(e.stack),e.status&&e.message?(R.info("errormiddleware"),r.status(e.status).send(e.message),n()):(r.status(500).send("Server error."),n())})),D.listen(process.env.PORT,(function(){R.info("Server online at port "+process.env.PORT)}));
