"use strict";var e=require("cors"),r=require("express"),t=require("winston"),n=require("atob"),o=require("bcrypt"),a=require("http-errors"),s=require("jsonwebtoken"),u=require("dotenv"),i=require("morgan"),l=require("fs");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function f(e){if(e&&e.__esModule)return e;var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}var p=c(e),d=c(r),v=f(t),m=c(n),h=c(o),b=c(a),w=c(s),y=c(u),g=c(i),E=c(l);v.addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});var S=v.format.combine(v.format.timestamp({format:"YYYY-MM-DD HH:mm:ss:ms"}),v.format.colorize({all:!0}),v.format.printf((function(e){return e.timestamp+" "+e.level+": "+e.message}))),O=[new v.transports.Console,new v.transports.File({filename:"../logs/error.log",level:"error"}),new v.transports.File({filename:"../logs/all.log"})],R=v.createLogger({level:"development"===(process.env.NODE_ENV||"development")?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},format:S,transports:O});function k(e,r,t,n){return new(t||(t=Promise))((function(o,a){function s(e){try{i(n.next(e))}catch(e){a(e)}}function u(e){try{i(n.throw(e))}catch(e){a(e)}}function i(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,u)}i((n=n.apply(e,r||[])).next())}))}function P(e,r){var t,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=r.call(e,s)}catch(e){a=[6,e],n=0}finally{t=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}if(y.default.config(),!process.env.PASSWORD)throw new Error("Environment variable PASSWORD not set.");if(!process.env.SECRET_KEY)throw new Error("Environment variable SECRET_KEY not set.");var j={password:process.env.PASSWORD,secretKey:process.env.SECRET_KEY},q=function(e,r,t){return k(this,void 0,void 0,(function(){var n,o,a,s,u,i,l,c;return P(this,(function(f){switch(f.label){case 0:if(!(n=e.headers.authorization))return[2,t(b.default(401,"Unauthorized."))];o=n.split("Basic "),a=o[1];try{s=m.default(a)}catch(e){return[2,t(b.default(400,"Malformed auth token."))]}return u=s.split(":"),i=u[0],l=u[1],i!==process.env.USERNAME?[2,t(b.default(401,"Unauthorized."))]:[4,h.default.compare(l,j.password)];case 1:return f.sent()?(c=w.default.sign({username:i,mapToken:process.env.MAP_TOKEN},j.secretKey,{expiresIn:"1h"}),r.type("application/json").status(200).send(JSON.stringify({token:c})),[2,t()]):[2,t(b.default(401,"Unauthorized."))]}}))}))},_=function(e,r,t){var n=e.headers.authorization;if(!n)return t(b.default(401,"Unauthorized"));var o=n.split("Bearer ")[1];try{w.default.verify(o,j.secretKey)}catch(e){return t(b.default(401,"Unauthorized"))}};var z={write:function(e){return R.http(e)}},T=g.default(":method :url :status :res[content-length] - :response-time ms",{stream:z,skip:function(){return"development"!==(process.env.NODE_ENV||"development")}}),D=d.default.Router();D.post("/",q);var x=function(e,r,t){return r.status(200).type("application/json"),new Promise((function(e){var n=E.default.createReadStream("data/boat_ramps.geojson").pipe(r);n.on("close",(function(){r.end(),e(t())})),n.on("error",(function(){e(t(b.default(500,"Server failed to read data.")))}))}))},K=d.default.Router();K.get("/boat-ramps",x);var N=d.default();N.use(T),N.use(p.default({origin:process.env.API_HOST,optionsSuccessStatus:200})),N.use("/auth",D),N.use("/data",(function(e,r,t){_(e,r,t),t()}),K),N.use((function(e,r,t,n){return R.error(e.stack),e.status&&e.message?(R.info("errormiddleware"),t.status(e.status).send(e.message),n()):(t.status(500).send("Server error."),n())})),N.listen(process.env.PORT,(function(){R.info("Server online at port "+process.env.PORT)}));
